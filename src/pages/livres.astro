---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';

// R√©cup√©ration des livres
const books = await getCollection('books');

// Tri des livres par note (du plus √©lev√© au plus bas), puis par ann√©e
const sortedBooks = books.sort((a, b) => {
  if (a.data.note && b.data.note) {
    if (b.data.note !== a.data.note) {
      return b.data.note - a.data.note;
    }
  }
  return (b.data.publishYear || 0) - (a.data.publishYear || 0);
});

// Cat√©gorisation des livres
const categories = {
  "D√©veloppement & Tech": books.filter(book => 
    book.data.category === "d√©veloppement" || 
    book.data.tags?.some(tag => 
      tag.toLowerCase().includes('d√©veloppement') || 
      tag.toLowerCase().includes('tech') ||
      tag.toLowerCase().includes('programming')
    )
  ),
  "Management & Leadership": books.filter(book => 
    book.data.category === "management" || 
    book.data.tags?.some(tag => 
      tag.toLowerCase().includes('management') || 
      tag.toLowerCase().includes('leadership') ||
      tag.toLowerCase().includes('√©quipe')
    )
  ),
  "Productivit√© & M√©thodes": books.filter(book => 
    book.data.category === "productivit√©" || 
    book.data.tags?.some(tag => 
      tag.toLowerCase().includes('productivit√©') || 
      tag.toLowerCase().includes('m√©thode') ||
      tag.toLowerCase().includes('temps')
    )
  ),
  "Business & Strat√©gie": books.filter(book => 
    book.data.category === "business" || 
    book.data.tags?.some(tag => 
      tag.toLowerCase().includes('business') || 
      tag.toLowerCase().includes('strat√©gie') ||
      tag.toLowerCase().includes('marketing')
    )
  )
};

// Fonction pour obtenir la couleur de la note
function getNoteColor(note: number): string {
  if (note >= 4.5) return "text-green-600 dark:text-green-400";
  if (note >= 4.0) return "text-yellow-600 dark:text-yellow-400";
  if (note >= 3.5) return "text-orange-600 dark:text-orange-400";
  return "text-red-600 dark:text-red-400";
}

// Fonction pour obtenir le texte de la note
function getNoteText(note: number): string {
  if (note >= 4.5) return "Excellent";
  if (note >= 4.0) return "Tr√®s bon";
  if (note >= 3.5) return "Bon";
  return "Moyen";
}

// Statistiques
const totalBooks = books.length;
const averageNote = books.reduce((sum, book) => sum + (book.data.note || 0), 0) / books.length;
const topRatedBooks = books.filter(book => book.data.note && book.data.note >= 4.5).length;
---

<BaseLayout title="Livres Recommand√©s | G√©rald Pam√©ole" description="D√©couvrez ma s√©lection de livres qui ont marqu√© mon parcours professionnel et qui peuvent enrichir le v√¥tre.">
	<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
		<!-- Hero Section -->
		<section class="relative py-24 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 text-white overflow-hidden">
			<!-- Background Animation -->
			<div class="absolute inset-0">
				<div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-600/20 to-purple-600/20"></div>
				<div class="absolute top-1/4 left-1/4 w-64 h-64 bg-white/10 rounded-full blur-3xl animate-pulse"></div>
				<div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-white/5 rounded-full blur-3xl animate-pulse delay-1000"></div>
			</div>
			
			<div class="container mx-auto px-4 text-center relative z-10">
				<h1 class="text-5xl md:text-6xl font-bold mb-6 animate-fade-in">
					üìö Livres Recommand√©s
				</h1>
				<p class="text-xl md:text-2xl max-w-4xl mx-auto mb-12 opacity-90 animate-slide-up">
					Une s√©lection personnelle de livres qui ont transform√© ma vision du d√©veloppement, 
					du management et de la productivit√©. Chaque livre a √©t√© lu, analys√© et not√©.
				</p>
				
				<!-- Statistiques -->
				<div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-3xl mx-auto">
					<div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6 hover:bg-white/20 transition-all duration-300 transform hover:scale-105">
						<div class="text-4xl font-bold mb-2">{totalBooks}</div>
						<div class="text-sm opacity-90">Livres lus</div>
					</div>
					<div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6 hover:bg-white/20 transition-all duration-300 transform hover:scale-105">
						<div class="text-4xl font-bold mb-2">{averageNote.toFixed(1)}</div>
						<div class="text-sm opacity-90">Note moyenne</div>
					</div>
					<div class="bg-white/10 backdrop-blur-sm rounded-2xl p-6 hover:bg-white/20 transition-all duration-300 transform hover:scale-105">
						<div class="text-4xl font-bold mb-2">{topRatedBooks}</div>
						<div class="text-sm opacity-90">Excellents</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Navigation par Cat√©gorie -->
		<section class="py-8 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
			<div class="container mx-auto px-4">
				<div class="flex flex-wrap gap-3 justify-center">
					{Object.entries(categories).map(([categoryName, categoryBooks]) => (
						<a 
							href={`#${categoryName.toLowerCase().replace(/\s+/g, '-')}`}
							class="px-6 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors font-medium"
						>
							{categoryName} ({categoryBooks.length})
						</a>
					))}
				</div>
			</div>
		</section>

		<!-- Livres par Cat√©gorie -->
		<section class="py-20">
			<div class="container mx-auto px-4">
				{Object.entries(categories).map(([categoryName, categoryBooks]) => (
					<div id={categoryName.toLowerCase().replace(/\s+/g, '-')} class="mb-20">
						<!-- Header de la cat√©gorie -->
						<div class="text-center mb-12">
							<h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
								{categoryName}
							</h2>
							<p class="text-lg text-gray-600 dark:text-gray-300">
								{categoryBooks.length} livre{categoryBooks.length > 1 ? 's' : ''} dans cette cat√©gorie
							</p>
						</div>

						<!-- Grille des livres -->
						{categoryBooks.length > 0 ? (
							<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
								{categoryBooks.map((book) => (
									<div class="group bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2">
										<!-- Image de couverture -->
										<div class="relative h-64 bg-gradient-to-br from-indigo-500 to-purple-600">
											<div class="absolute inset-0 bg-black/20"></div>
											
											<!-- Note et ann√©e -->
											<div class="absolute top-4 left-4 text-white">
												<div class="flex items-center space-x-2">
													<span class="text-sm font-medium">{book.data.publishYear}</span>
													{book.data.note && (
														<>
															<span class="text-sm">‚Ä¢</span>
															<div class="flex items-center">
																{Array.from({ length: 5 }).map((_, i) => (
																	<svg 
																		key={i}
																		class={`w-4 h-4 ${i < book.data.note! ? 'text-yellow-400' : 'text-gray-300'}`}
																		fill="currentColor" 
																		viewBox="0 0 20 20"
																	>
																		<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
																	</svg>
																))}
															</div>
														</>
													)}
												</div>
											</div>

											<!-- Badge recommand√© -->
											{book.data.note && book.data.note >= 4.5 && (
												<div class="absolute top-4 right-4">
													<span class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-medium">
														‚≠ê Recommand√©
													</span>
												</div>
											)}

											<!-- Note textuelle -->
											{book.data.note && (
												<div class="absolute bottom-4 right-4">
													<div class={`bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-sm font-medium ${getNoteColor(book.data.note)}`}>
														{book.data.note}/5 - {getNoteText(book.data.note)}
													</div>
												</div>
											)}
										</div>

										<!-- Contenu du livre -->
										<div class="p-6">
											<h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2 line-clamp-2">
												{book.data.title}
											</h3>
											<p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
												par <span class="font-medium">{book.data.author}</span>
											</p>
											<p class="text-gray-600 dark:text-gray-300 text-sm line-clamp-3 mb-4">
												{book.data.description}
											</p>
											
											<!-- Tags -->
											{book.data.tags && book.data.tags.length > 0 && (
												<div class="flex flex-wrap gap-2 mb-4">
													{book.data.tags.slice(0, 3).map((tag) => (
														<span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs rounded">
															{tag}
														</span>
													))}
												</div>
											)}

											<!-- Actions -->
											<div class="flex items-center justify-between">
												<a 
													href={`/books/${book.slug}`}
													class="inline-flex items-center text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium text-sm"
												>
													Lire la critique
													<svg class="ml-1 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
														<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
													</svg>
												</a>
												
												{book.data.amazonLink && (
													<a 
														href={book.data.amazonLink}
														target="_blank"
														rel="noopener noreferrer"
														class="inline-flex items-center px-3 py-1 bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300 text-xs rounded-full hover:bg-orange-200 dark:hover:bg-orange-900/50 transition-colors"
													>
														<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
															<path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
														</svg>
														Amazon
													</a>
												)}
											</div>
										</div>
									</div>
								))}
							</div>
						) : (
							<div class="text-center py-12">
								<div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
									<i class="fas fa-book text-2xl text-gray-400"></i>
								</div>
								<h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Aucun livre dans cette cat√©gorie</h3>
								<p class="text-gray-600 dark:text-gray-400">Des livres seront bient√¥t ajout√©s dans cette cat√©gorie.</p>
							</div>
						)}
					</div>
				))}
			</div>
		</section>

		<!-- CTA Section -->
		<section class="py-20 bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
			<div class="container mx-auto px-4 text-center">
				<h2 class="text-4xl font-bold mb-6">
					Une recommandation de livre ?
				</h2>
				<p class="text-xl mb-12 max-w-3xl mx-auto opacity-90">
					Vous avez lu un livre qui vous a marqu√© ? N'h√©sitez pas √† me le recommander !
				</p>
				<div class="flex flex-col sm:flex-row gap-6 justify-center">
					<a 
						href="/contact" 
						class="inline-flex items-center px-8 py-4 bg-white text-indigo-600 font-semibold rounded-xl hover:bg-gray-100 transition-all duration-300 transform hover:scale-105 shadow-lg"
					>
						Me recommander un livre
						<svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
						</svg>
					</a>
					<a 
						href="/blog" 
						class="inline-flex items-center px-8 py-4 border-2 border-white text-white font-semibold rounded-xl hover:bg-white hover:text-indigo-600 transition-all duration-300 transform hover:scale-105"
					>
						Voir mes articles
						<svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
						</svg>
					</a>
				</div>
			</div>
		</section>
	</div>
</BaseLayout>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	
	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	@keyframes fade-in {
		from { opacity: 0; transform: translateY(20px); }
		to { opacity: 1; transform: translateY(0); }
	}

	@keyframes slide-up {
		from { opacity: 0; transform: translateY(30px); }
		to { opacity: 1; transform: translateY(0); }
	}

	.animate-fade-in {
		animation: fade-in 0.8s ease-out;
	}

	.animate-slide-up {
		animation: slide-up 1s ease-out 0.2s both;
	}
</style>
