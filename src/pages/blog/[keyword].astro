---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

export async function getStaticPaths() {
  const articles = await getCollection('articles');
  const keywords = new Set();
  
  // Extraire tous les mots-clés uniques
  articles.forEach(article => {
    if ((article.data as any).keywords) {
      (article.data as any).keywords.forEach((keyword: string) => {
        const cleanKeyword = keyword.replace('#', '').toLowerCase();
        keywords.add(cleanKeyword);
      });
    }
  });
  
  return Array.from(keywords).map(keyword => ({
    params: { keyword },
    props: { keyword }
  }));
}

const { keyword } = Astro.params;
const articles = await getCollection('articles');

// Filtrer les articles par mot-clé
const filteredArticles = articles.filter(article => {
  if (!(article.data as any).keywords) return false;
  return (article.data as any).keywords.some((k: string) => 
    k.replace('#', '').toLowerCase() === keyword
  );
});

// Tri par date
const sortedArticles = filteredArticles.sort((a, b) => {
  const dateA = new Date(a.data.publishDate || '2024-01-01');
  const dateB = new Date(b.data.publishDate || '2024-01-01');
  return dateB.getTime() - dateA.getTime();
});

function formatDate(date: Date | string): string {
  const dateObj = typeof date === 'string' ? new Date(date) : date;
  return dateObj.toLocaleDateString('fr-FR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

// Métadonnées SEO optimisées
const seoTitle = `Articles sur ${keyword} | Gérald Paméole - Expert Transformation Digitale`;
const seoDescription = `Découvrez tous les articles sur ${keyword} par Gérald Paméole. Expertise en formation, gestion de projet, développement web et transformation digitale.`;
const seoKeywords = `${keyword}, formation, gestion projet, développement web, qualité, commercial, gérald pameole, expertise, conseil`;

// Schema.org pour la page de mot-clé
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": `Articles sur ${keyword}`,
  "description": seoDescription,
  "url": Astro.url.toString(),
  "mainEntity": {
    "@type": "ItemList",
    "numberOfItems": sortedArticles.length,
    "itemListElement": sortedArticles.map((article, index) => ({
      "@type": "ListItem",
      "position": index + 1,
      "item": {
        "@type": "Article",
        "headline": article.data.title,
        "url": `/articles/${article.slug}`,
        "datePublished": article.data.publishDate
      }
    }))
  }
};
---

<BaseLayout 
  title={seoTitle}
  description={seoDescription}
  keywords={seoKeywords}
  type="website"
>
  <!-- Données structurées -->
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  
  <main class="content-container-wide py-12">
    <!-- En-tête de la page de mot-clé -->
    <section class="py-16 md:py-24 bg-gradient-to-r from-indigo-600/10 to-violet-600/10 w-screen relative overflow-hidden" style="margin-left: calc(50% - 50vw); margin-right: calc(50% - 50vw)">
      <div class="content-container text-center relative z-10">
        <div class="flex items-center justify-center gap-4 mb-6">
          <div class="p-4 rounded-xl bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300">
            <i class="fas fa-hashtag text-3xl"></i>
          </div>
        </div>
        
        <h1 class="text-4xl md:text-5xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-blue-500">
          Articles sur #{keyword}
        </h1>
        
        <p class="text-xl text-[#111827] dark:text-gray-200 mb-8 max-w-3xl mx-auto">
          {sortedArticles.length} article{sortedArticles.length > 1 ? 's' : ''} trouvé{sortedArticles.length > 1 ? 's' : ''} sur le thème <strong>#{keyword}</strong>
        </p>
        
        <div class="flex flex-wrap justify-center gap-3">
          <a href="/blog" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
            <i class="fas fa-arrow-left mr-2"></i>Retour au blog
          </a>
        </div>
      </div>
    </section>
    
    <!-- Articles filtrés -->
    <div class="content-container mt-12">
      {sortedArticles.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {sortedArticles.map((article, index) => (
            <article class="article-card bg-white dark:bg-gray-800 rounded-lg p-6 hover:shadow-xl hover:-translate-y-2 transition-all duration-500 border border-gray-200 dark:border-gray-600 group" style={`animation-delay: ${index * 0.1}s`}>
              <!-- Mots-clés SEO -->
              {(article.data as any).keywords && (article.data as any).keywords.length > 0 && (
                <div class="mb-4">
                  <div class="flex flex-wrap gap-2">
                    {(article.data as any).keywords.slice(0, 3).map((kw: string, idx: number) => (
                      <span class={`px-2 py-1 text-xs font-medium rounded-full transition-all duration-300 ${
                        kw.replace('#', '').toLowerCase() === keyword 
                          ? 'bg-blue-600 text-white shadow-lg' 
                          : 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300'
                      }`}>
                        {kw}
                      </span>
                    ))}
                    {(article.data as any).keywords.length > 3 && (
                      <span class="px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400 rounded-full">
                        +{(article.data as any).keywords.length - 3}
                      </span>
                    )}
                  </div>
                </div>
              )}
              
              <h3 class="text-lg font-bold text-[#111827] dark:text-white mb-3 line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                <a href={`/articles/${article.slug}`} class="hover:underline">
                  {article.data.title}
                </a>
              </h3>
              
              <p class="text-[#111827] dark:text-gray-300 mb-4 line-clamp-3">
                {article.data.description}
              </p>
              
              <div class="flex items-center justify-between">
                <span class="text-sm text-gray-500 dark:text-gray-400">
                  <i class="fas fa-calendar-alt mr-1"></i>
                  {formatDate(article.data.publishDate)}
                </span>
                <a href={`/articles/${article.slug}`} 
                   class="inline-flex items-center gap-1 text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 font-medium text-sm transition-all duration-300 hover:gap-2">
                  Lire l'article
                  <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                </a>
              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center py-16">
          <div class="mb-6">
            <i class="fas fa-search text-6xl text-gray-300 dark:text-gray-600"></i>
          </div>
          <h2 class="text-2xl font-bold text-[#111827] dark:text-white mb-4">
            Aucun article trouvé
          </h2>
          <p class="text-gray-600 dark:text-gray-400 mb-8">
            Aucun article n'a été trouvé pour le mot-clé <strong>#{keyword}</strong>
          </p>
          <a href="/blog" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">
            Voir tous les articles
          </a>
        </div>
      )}
    </div>
  </main>
</BaseLayout>

<style>
  .article-card {
    position: relative;
    overflow: hidden;
  }
  
  .article-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
  }
  
  .article-card:hover::before {
    left: 100%;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
