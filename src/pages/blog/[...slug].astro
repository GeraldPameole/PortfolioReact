---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import BackButton from '../../components/BackButton.astro';
import ArticleProgressBar from '../../components/ArticleProgressBar.astro';
import { calculateReadingTime, mapToStandardTheme, standardThemes } from '../../utils/themeUtils';

export async function getStaticPaths() {
	const articles = await getCollection('articles');
	return articles.map(article => ({
		params: { slug: article.slug },
		props: { article },
	}));
}

const { article } = Astro.props;
const { Content } = await article.render();
const theme = article.data.theme || (article.data.tags && article.data.tags.length > 0 ? article.data.tags[0] : "autre");
const standardTheme = mapToStandardTheme(theme);
const themeConfig = standardThemes[standardTheme];

// Métadonnées pour SEO
const pageTitle = `${article.data.title} | Blog`;
const pageDescription = article.data.description;
---

<BaseLayout 
	title={pageTitle} 
	description={pageDescription}
	customClass="bg-gradient-to-br from-gray-50 to-white dark:from-gray-900 dark:to-gray-800"
	fullWidth={true}
>
	<main class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8 py-12 relative">
		<BackButton href="/blog" text="Retour aux articles" />
		<ArticleProgressBar />
		
		<article class="content-typography prose-lg dark:prose-invert max-w-none">
			<header class="mb-12">
				<!-- Domaine et Date de parution -->
				<div class="flex items-center gap-4 mb-6">
					<span class="px-4 py-2 rounded-full text-sm font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200">
						{article.data.domain ? article.data.domain.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Domaine non défini'}
					</span>
					<span class="mx-2 text-gray-400">•</span>
					<time class="text-[#111827] dark:text-gray-400">
						{new Date(article.data.publishDate).toLocaleDateString('fr-FR', {
							year: 'numeric',
							month: 'long',
							day: 'numeric'
						})}
					</time>
					<span class="text-[#111827] dark:text-gray-400 flex items-center">
						<i class="fas fa-clock mr-1"></i>
						{calculateReadingTime(article.body)} min de lecture
					</span>
				</div>
				
				<h1 class="text-4xl font-bold mb-6">{article.data.title}</h1>
				
				{article.data.image && (
					<div class="relative h-96 rounded-xl overflow-hidden mb-8">
						<img 
							src={article.data.image} 
							alt={article.data.title} 
							class="w-full h-full object-cover"
						/>
					</div>
				)}
				
				<p class="text-xl text-[#111827] dark:text-gray-300 mb-8">{article.data.description}</p>
				
				{article.data.tags && article.data.tags.length > 0 && (
					<div class="flex flex-wrap gap-2">
						{article.data.tags.map((tag) => (
							<span class="px-3 py-1 bg-gray-100 dark:bg-gray-800 text-[#111827] dark:text-gray-300 rounded-full text-sm">
								#{tag}
							</span>
						))}
					</div>
				)}
			</header>
			
			<div class="content">
				<Content />
			</div>
		</article>
	</main>
</BaseLayout>

<style>
	/* Styles unifiés gérés par content.css */
	
	.prose h2 {
		@apply text-3xl font-bold mt-12 mb-6;
	}
	
	.prose h3 {
		@apply text-2xl font-bold mt-8 mb-4;
	}
	
	.prose p {
		@apply mb-6 leading-relaxed;
	}
	
	.prose ul, .prose ol {
		@apply mb-6 pl-6;
	}
	
	.prose li {
		@apply mb-2;
	}
	
	.prose code {
		@apply bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded text-sm;
	}
	
	.prose pre {
		@apply bg-gray-100 dark:bg-gray-800 p-4 rounded-lg overflow-x-auto mb-6;
	}
	
	.prose blockquote {
		@apply border-l-4 border-indigo-500 pl-4 italic my-6;
	}
	
	.prose img {
		@apply rounded-lg my-6;
	}

	/* Styles pour les tableaux - Amélioration de la visibilité */
	.content-typography table,
	.prose table {
		width: 100%;
		border-collapse: collapse;
		margin: 2rem 0;
		font-size: 0.875rem;
		background: white;
		border-radius: 0.5rem;
		overflow: hidden;
		box-shadow: 
			0 4px 6px -1px rgb(0 0 0 / 0.1),
			0 2px 4px -2px rgb(0 0 0 / 0.1);
		border: 2px solid #e5e7eb;
		display: table;
		table-layout: auto;
	}

	.dark .content-typography table,
	.dark .prose table {
		background: #1f2937;
		border: 2px solid #374151;
	}

	/* En-têtes de tableau */
	.content-typography thead,
	.prose thead {
		background: #6b7280;
		border-bottom: 2px solid #4b5563;
	}

	.dark .content-typography thead,
	.dark .prose thead {
		background: #4b5563;
		border-bottom-color: #374151;
	}

	.content-typography th,
	.prose th {
		padding: 0.75rem 1rem;
		text-align: left;
		font-weight: 600;
		color: #ffffff;
		border-right: 1px solid #9ca3af;
		font-size: 0.875rem;
		line-height: 1.25rem;
		text-transform: uppercase;
		letter-spacing: 0.025em;
		background: #6b7280;
	}

	.dark .content-typography th,
	.dark .prose th {
		color: #ffffff;
		border-right-color: #6b7280;
		background: #4b5563;
	}

	.content-typography th:last-child,
	.prose th:last-child {
		border-right: none;
	}

	/* Cellules du tableau */
	.content-typography td,
	.prose td {
		padding: 0.75rem 1rem;
		border-bottom: 1px solid #e2e8f0;
		border-right: 1px solid #e2e8f0;
		color: #1e293b;
		font-size: 0.875rem;
		line-height: 1.25rem;
		vertical-align: top;
		background: white;
	}

	.dark .content-typography td,
	.dark .prose td {
		color: #d1d5db;
		border-bottom-color: #4b5563;
		border-right-color: #4b5563;
		background: #1f2937;
	}

	.content-typography td:last-child,
	.prose td:last-child {
		border-right: none;
	}

	/* Lignes alternées pour une meilleure lisibilité */
	.content-typography tbody tr:nth-child(even),
	.prose tbody tr:nth-child(even) {
		background: #f8fafc;
	}

	.content-typography tbody tr:nth-child(even) td,
	.prose tbody tr:nth-child(even) td {
		background: #f8fafc;
	}

	.dark .content-typography tbody tr:nth-child(even),
	.dark .prose tbody tr:nth-child(even) {
		background: #374151;
	}

	.dark .content-typography tbody tr:nth-child(even) td,
	.dark .prose tbody tr:nth-child(even) td {
		background: #374151;
	}

	/* Effet hover sur les lignes */
	.content-typography tbody tr:hover,
	.prose tbody tr:hover {
		background: #f1f5f9;
		transition: background-color 0.2s ease;
	}

	.dark .content-typography tbody tr:hover,
	.dark .prose tbody tr:hover {
		background: #4b5563;
	}

	/* Dernière ligne sans bordure */
	.content-typography tbody tr:last-child td,
	.prose tbody tr:last-child td {
		border-bottom: none;
	}

	/* Conteneur pour tableaux responsives */
	.content-typography .table-container,
	.prose .table-container {
		overflow-x: auto;
		margin: 2rem 0;
		border-radius: 0.5rem;
		box-shadow: 
			0 1px 3px 0 rgb(0 0 0 / 0.1),
			0 1px 2px -1px rgb(0 0 0 / 0.1);
	}

	/* Responsive pour mobile */
	@media (max-width: 768px) {
		.content-typography table,
		.prose table {
			font-size: 0.75rem;
		}

		.content-typography th,
		.content-typography td,
		.prose th,
		.prose td {
			padding: 0.5rem 0.75rem;
		}
	}
</style>

<script defer is:inline>
  // Ajout de Font Awesome
  if (!document.querySelector('#font-awesome')) {
    const link = document.createElement('link');
    link.id = 'font-awesome';
    link.rel = 'stylesheet';
    link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
    document.head.appendChild(link);
  }
</script> 