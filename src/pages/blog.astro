---
import { getCollection } from 'astro:content';
import { getFeaturedArticlesForDomain } from '../config/featured-articles';
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';

// R√©cup√©ration des articles et livres
const articles = await getCollection('articles');
const books = await getCollection('books');

// Tri des articles par date de publication (du plus r√©cent au plus ancien)
const sortedArticles = articles.sort((a, b) => {
	const dateA = new Date(a.data.publishDate || '2024-01-01');
	const dateB = new Date(b.data.publishDate || '2024-01-01');
	return dateB.getTime() - dateA.getTime();
});

// Tri des livres par ann√©e de publication
const sortedBooks = books.sort((a, b) => (b.data.publishYear || 0) - (a.data.publishYear || 0));

// Fonction pour obtenir les articles d'un domaine sp√©cifique
function getArticlesForDomain(domain: string) {
  const featuredSlugs = getFeaturedArticlesForDomain(domain);
  const featuredArticles = articles.filter(article => featuredSlugs.includes(article.slug));
  
  // Toujours utiliser tous les articles du domaine, mais prioriser les featured
  const allDomainArticles = getAllArticlesForDomain(domain);
  
  // Si on a des featured articles, les mettre en premier
  if (featuredArticles.length > 0) {
    const otherArticles = allDomainArticles.filter(article => 
      !featuredSlugs.includes(article.slug)
    );
    return [...featuredArticles, ...otherArticles].slice(0, 6);
  }
  
  // Sinon, utiliser tous les articles du domaine (limit√©s √† 6)
  return allDomainArticles.slice(0, 6);
}

// Fonction pour obtenir TOUS les articles d'un domaine (pas seulement les featured)
function getAllArticlesForDomain(domain: string) {
  return articles.filter(article => {
    // Astro article.id contient le chemin relatif depuis content/articles
    // Format: "formation/article.md" ou "gestion-projet/article.md"
    const articlePath = article.id.toLowerCase();
    const domainLower = domain.toLowerCase();
    
    // V√©rifier si l'ID commence par le nom du dossier du domaine
    // Format Astro: "formation/apprentissage-continu.md"
    return articlePath.startsWith(`${domainLower}/`) ||
           articlePath.includes(`/${domainLower}/`) ||
           (article.data as any).domain === domainLower;
  }).sort((a, b) => {
    if (a.data.featured && !b.data.featured) return -1;
    if (!a.data.featured && b.data.featured) return 1;
    return new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime();
  });
}

// D√©finition des domaines de comp√©tence
const domainesCompetences = {
	"Formation & P√©dagogie": {
		description: "Articles sur la formation, le d√©veloppement des comp√©tences et l'apprentissage continu",
		color: "red",
		bgColor: "bg-red-600 dark:bg-red-500",
		icon: "fas fa-graduation-cap",
		domainKey: "formation",
		keywords: ["#formation", "#apprentissage", "#comp√©tences", "#mentorat", "#elearning"],
		articles: getArticlesForDomain('formation').slice(0, 6),
		totalArticles: getAllArticlesForDomain('formation').length
	},
	"Gestion de Projet T√©l√©com": {
		description: "Pilotage de projets complexes, gestion d'√©quipes et m√©thodologies agiles",
		color: "blue", 
		bgColor: "bg-blue-600 dark:bg-blue-500", 
		icon: "fas fa-tasks",
		domainKey: "gestion-projet",
		keywords: ["#gestionprojet", "#agile", "#scrum", "#management", "#√©quipe"],
		articles: getArticlesForDomain('gestion-projet').slice(0, 6),
		totalArticles: getAllArticlesForDomain('gestion-projet').length
	},
	"D√©veloppement Web & Technologies": {
		description: "Tendances, technologies et bonnes pratiques du d√©veloppement web moderne",
		color: "purple",
		bgColor: "bg-purple-600 dark:bg-purple-500",
		icon: "fas fa-code",
		domainKey: "developpement-web",
		keywords: ["#web", "#javascript", "#react", "#frontend", "#technologies"],
		articles: getArticlesForDomain('developpement-web').slice(0, 6),
		totalArticles: getAllArticlesForDomain('developpement-web').length
	},
	"Qualit√© & Processus": {
		description: "Am√©lioration continue, certification et optimisation des processus",
		color: "orange",
		bgColor: "bg-orange-600 dark:bg-orange-500",
		icon: "fas fa-check-circle",
		domainKey: "qualite-process",
		keywords: ["#qualit√©", "#processus", "#am√©lioration", "#certification", "#iso"],
		articles: getArticlesForDomain('qualite-process').slice(0, 6),
		totalArticles: getAllArticlesForDomain('qualite-process').length
	},
	"Gestion des Talents": {
		description: "Strat√©gies et m√©thodes pour g√©rer, d√©velopper et fid√©liser les talents",
		color: "green",
		bgColor: "bg-green-600 dark:bg-green-500",
		icon: "fas fa-users",
		domainKey: "gestion-talents",
		keywords: ["#talents", "#gestion", "#recrutement", "#fid√©lisation", "#leadership"],
		articles: getArticlesForDomain('gestion-talents').slice(0, 6),
		totalArticles: getAllArticlesForDomain('gestion-talents').length
	},
	"D√©veloppement Commercial": {
		description: "Strat√©gies commerciales, n√©gociation et d√©veloppement de partenariats",
		color: "indigo",
		bgColor: "bg-indigo-600 dark:bg-indigo-500",
		icon: "fas fa-handshake",
		domainKey: "developpement-commercial",
		keywords: ["#commercial", "#n√©gociation", "#partenariats", "#vente", "#strat√©gie"],
		articles: getArticlesForDomain('developpement-commercial').slice(0, 6),
		totalArticles: getAllArticlesForDomain('developpement-commercial').length
	},
	"Productivit√© & M√©thodes": {
		description: "Techniques de productivit√©, gestion du temps et m√©thodes de travail",
		color: "teal",
		bgColor: "bg-teal-600 dark:bg-teal-500",
		icon: "fas fa-clock",
		domainKey: "productivite-methodes",
		keywords: ["#productivit√©", "#temps", "#m√©thodes", "#gtd", "#pomodoro"],
		articles: getArticlesForDomain('productivite-methodes').slice(0, 6),
		totalArticles: getAllArticlesForDomain('productivite-methodes').length
	},
	"Transformation Digitale": {
		description: "IA, transformation num√©rique et nouvelles technologies",
		color: "pink",
		bgColor: "bg-pink-600 dark:bg-pink-500",
		icon: "fas fa-robot",
		domainKey: "transformation-digitale",
		keywords: ["#ia", "#transformation", "#num√©rique", "#innovation", "#technologies"],
		articles: getArticlesForDomain('transformation-digitale').slice(0, 6),
		totalArticles: getAllArticlesForDomain('transformation-digitale').length
	}
};

// Couleurs pour les badges
const colorClasses = {
	red: "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-300",
	blue: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-300",
	purple: "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-300",
	orange: "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-300",
	green: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300",
	indigo: "bg-indigo-100 text-indigo-800 dark:bg-indigo-900/30 dark:text-indigo-300",
	teal: "bg-teal-100 text-teal-800 dark:bg-teal-900/30 dark:text-teal-300",
	pink: "bg-pink-100 text-pink-800 dark:bg-pink-900/30 dark:text-pink-300"
};

// Fonction pour formater la date
function formatDate(date: Date | string): string {
	const dateObj = typeof date === 'string' ? new Date(date) : date;
	return dateObj.toLocaleDateString('fr-FR', {
		year: 'numeric',
		month: 'long',
		day: 'numeric'
	});
}

// Livres recommand√©s (top 4)
const livresRecommandes = sortedBooks.slice(0, 4);

// Statistiques
const totalArticles = articles.length;
const totalBooks = books.length;
const totalDomaines = Object.keys(domainesCompetences).length;
---

<BaseLayout 
	title="Blog | G√©rald Pam√©ole" 
	description="D√©couvrez mes articles sur le d√©veloppement web, la gestion de projet, la formation et bien plus encore. Organis√©s par domaine d'expertise."
>
	<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
		<!-- Hero Section -->
		<section class="py-20 bg-gradient-to-r from-indigo-600 to-purple-700 text-white relative overflow-hidden">
			<!-- Background Animation -->
			<div class="absolute inset-0">
				<div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-indigo-600/20 to-purple-600/20"></div>
				<div class="absolute top-1/4 left-1/4 w-64 h-64 bg-white/10 rounded-full blur-3xl animate-pulse"></div>
				<div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-white/5 rounded-full blur-3xl animate-pulse delay-1000"></div>
			</div>
			
			<div class="container mx-auto px-4 text-center relative z-10">
				<h1 class="text-4xl md:text-5xl font-bold mb-6 animate-fade-in">üìù Blog & Articles</h1>
				<p class="text-xl max-w-3xl mx-auto mb-8 opacity-90">
					Explorez mes articles organis√©s par domaine d'expertise. D√©couvrez des contenus sp√©cialis√©s 
					sur le d√©veloppement web, la gestion de projet, la formation et bien plus encore.
				</p>
				
				<!-- Statistiques -->
				<div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-2xl mx-auto">
					<div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 hover:bg-white/20 transition-all duration-300 transform hover:scale-105">
						<div class="text-3xl font-bold">{totalArticles}</div>
						<div class="text-sm opacity-90">Articles</div>
				</div>
					<div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 hover:bg-white/20 transition-all duration-300 transform hover:scale-105">
						<div class="text-3xl font-bold">{totalBooks}</div>
						<div class="text-sm opacity-90">Livres</div>
							</div>
					<div class="bg-white/10 backdrop-blur-sm rounded-lg p-4 hover:bg-white/20 transition-all duration-300 transform hover:scale-105">
						<div class="text-3xl font-bold">{totalDomaines}</div>
						<div class="text-sm opacity-90">Domaines</div>
						</div>
					</div>
							</div>
		</section>

		<!-- Navigation rapide -->
		<section class="py-8 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40 backdrop-blur-sm bg-white/95 dark:bg-gray-800/95">
			<div class="container mx-auto px-4">
				<div class="flex flex-wrap gap-2 justify-center">
					{Object.entries(domainesCompetences).map(([domainName, domain]) => (
						<a 
							href={`#${domainName.toLowerCase().replace(/\s+/g, '-')}`}
							class="px-4 py-2 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-600 transition-all duration-300 hover:scale-105"
						>
							<i class={`${domain.icon} mr-2`}></i>
							{domainName}
						</a>
					))}
				</div>
			</div>
		</section>

		<!-- Section Livres Recommand√©s -->
		<section class="py-16 bg-white dark:bg-gray-800">
			<div class="container mx-auto px-4">
				<div class="text-center mb-12">
					<h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
						üìö Livres Recommand√©s
					</h2>
					<p class="text-lg text-gray-600 dark:text-gray-300 max-w-3xl mx-auto mb-8">
						D√©couvrez ma s√©lection de livres qui ont marqu√© mon parcours professionnel et qui peuvent enrichir le v√¥tre.
					</p>
					<a 
						href="/livres" 
						class="inline-flex items-center px-8 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-lg hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 transform hover:scale-105 shadow-lg"
					>
						Voir tous les livres
						<svg class="ml-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
						</svg>
					</a>
						</div>

				<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
					{livresRecommandes.map((book) => (
						<div class="bg-white dark:bg-gray-700 rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
							<div class="h-48 bg-gradient-to-br from-indigo-500 to-purple-600 relative overflow-hidden">
								<div class="absolute inset-0 bg-black/20"></div>
								<div class="absolute bottom-4 left-4 text-white">
									<div class="flex items-center space-x-2">
										<span class="text-sm font-medium">{book.data.publishYear}</span>
										{book.data.note && (
											<>
												<span class="text-sm">‚Ä¢</span>
												<div class="flex items-center">
													{Array.from({ length: 5 }).map((_, i) => (
														<svg 
															class={`w-4 h-4 ${i < book.data.note! ? 'text-yellow-400' : 'text-gray-300'}`}
															fill="currentColor" 
															viewBox="0 0 20 20"
														>
															<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
														</svg>
													))}
					</div>
											</>
										)}
							</div>
						</div>
								{book.data.note && book.data.note >= 4.5 && (
									<div class="absolute top-4 right-4">
										<span class="bg-yellow-400 text-yellow-900 px-2 py-1 rounded-full text-xs font-medium">
											‚≠ê Recommand√©
										</span>
					</div>
								)}
				</div>

							<div class="p-6">
								<h3 class="text-lg font-bold text-gray-900 dark:text-white mb-2 line-clamp-2">
									{book.data.title}
								</h3>
								<p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
									par {book.data.author}
								</p>
								<p class="text-gray-600 dark:text-gray-300 text-sm line-clamp-3 mb-4">
									{book.data.description}
								</p>
								
								<a 
									href={`/books/${book.slug}`}
									class="inline-flex items-center text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium text-sm transition-all duration-300"
								>
									Lire la critique
									<svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
									</svg>
								</a>
								</div>
							</div>
								))}
							</div>
						</div>
		</section>

		<!-- Articles par domaine -->
		<section class="py-16">
			<div class="container mx-auto px-4">
				{Object.entries(domainesCompetences).map(([domainName, domain]) => (
					<div id={domainName.toLowerCase().replace(/\s+/g, '-')} class="mb-16 scroll-mt-24">
						<!-- Header du domaine -->
					<div class="text-center mb-12">
							<div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-full mb-4">
								<i class={`${domain.icon} text-2xl`}></i>
													</div>
							<h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">{domainName}</h2>
							<p class="text-lg text-gray-600 dark:text-gray-300 max-w-2xl mx-auto mb-6">
								{domain.description}
							</p>
							
							<!-- Keywords -->
							<div class="flex flex-wrap gap-2 justify-center">
								{domain.keywords.slice(0, 5).map((keyword) => (
									<span class={`px-3 py-1 rounded-full text-sm ${colorClasses[domain.color as keyof typeof colorClasses]}`}>
										{keyword}
														</span>
								))}
							</div>
												</div>
												
						<!-- Articles du domaine -->
						{domain.articles.length > 0 ? (
							<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" data-domain={domain.domainKey} data-articles-count={domain.articles.length}>
								{domain.articles.map((article) => (
									<ArticleCard article={article} />
								))}
							</div>
						) : (
							<div class="text-center py-12">
								<div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
									<i class={`${domain.icon} text-2xl text-gray-400`}></i>
								</div>
								<h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Aucun article disponible</h3>
								<p class="text-gray-600 dark:text-gray-400">
									Des articles seront bient√¥t ajout√©s dans ce domaine.
									<br />
									<small class="text-xs text-gray-400">Total: {domain.totalArticles} articles dans ce domaine</small>
								</p>
								</div>
							)}
									
						<!-- Lien vers plus d'articles du domaine -->
									{domain.articles.length > 0 && (
							<div class="text-center mt-8">
											<a 
												href={`/domaines#${domain.domainKey}`}
									class="inline-flex items-center px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105"
											>
									Voir tous les articles de {domainName} ({domain.totalArticles})
												<svg class="ml-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
												</svg>
								</a>
							</div>
									)}
						</div>
					))}
			</div>
		</section>
		
		<!-- CTA -->
		<section class="py-16 bg-gray-100 dark:bg-gray-800">
			<div class="container mx-auto px-4 text-center">
				<h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-4">
					Int√©ress√© par un sujet sp√©cifique ?
				</h2>
				<p class="text-lg text-gray-600 dark:text-gray-300 mb-8 max-w-2xl mx-auto">
					N'h√©sitez pas √† me contacter pour discuter de vos besoins ou pour en savoir plus sur mes comp√©tences.
				</p>
				<div class="flex flex-col sm:flex-row gap-4 justify-center">
					<a 
						href="/contact" 
						class="inline-block px-8 py-3 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition-colors transform hover:scale-105"
					>
						Me contacter
					</a>
					<a 
						href="/domaines" 
						class="inline-block px-8 py-3 border border-indigo-600 text-indigo-600 dark:text-indigo-400 font-medium rounded-lg hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors transform hover:scale-105"
					>
						Explorer les domaines
					</a>
				</div>
			</div>
		</section>
				</div>
</BaseLayout>

<style>
	.line-clamp-2 {
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	
	.line-clamp-3 {
		display: -webkit-box;
		-webkit-line-clamp: 3;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	@keyframes fade-in {
		from { opacity: 0; transform: translateY(20px); }
		to { opacity: 1; transform: translateY(0); }
	}

	.animate-fade-in {
		animation: fade-in 0.8s ease-out;
	}

	.delay-1000 {
		animation-delay: 1s;
	}
</style>

<script defer is:inline>
	// Ajout de Font Awesome
	if (!document.querySelector('#font-awesome')) {
		const link = document.createElement('link');
		link.id = 'font-awesome';
		link.rel = 'stylesheet';
		link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
		document.head.appendChild(link);
	}
	
	// Animation au scroll
	document.addEventListener('DOMContentLoaded', () => {
		const observer = new IntersectionObserver((entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting) {
					entry.target.classList.add('animate-fade-in');
					observer.unobserve(entry.target);
				}
			});
		}, { threshold: 0.1 });
		
		document.querySelectorAll('section, [id^="formation"], [id^="gestion"], [id^="d√©veloppement"]').forEach(section => {
			observer.observe(section);
		});

		// Smooth scroll pour les ancres (uniquement les ancres, pas les liens vers /blog/)
		document.querySelectorAll('a[href^="#"]').forEach(anchor => {
			anchor.addEventListener('click', function (e) {
				const href = this.getAttribute('href') || '';
				// Ne pr√©venir le comportement par d√©faut QUE pour les vraies ancres
				if (href.startsWith('#') && !href.includes('/blog/')) {
					e.preventDefault();
					const target = document.querySelector(href);
					if (target) {
						target.scrollIntoView({ behavior: 'smooth', block: 'start' });
					}
				}
			});
		});

		// Assurer que TOUS les liens /blog/ fonctionnent correctement
		function initializeArticleLinks() {
			// Attendre un peu pour que le DOM soit compl√®tement charg√©
			const blogLinks = document.querySelectorAll('a[href^="/blog/"]');
			const articleCards = document.querySelectorAll('article, [class*="group"]');
			
			console.log('üìä D√©bogage articles:', {
				liensBlog: blogLinks.length,
				cartesArticles: articleCards.length,
				domainesAvecArticles: document.querySelectorAll('[data-articles-count]').length
			});
			
			// NE PAS ajouter de gestionnaires qui bloquent - laisser le comportement par d√©faut
			// Les liens HTML natifs fonctionnent parfaitement sans JavaScript
			blogLinks.forEach((link, index) => {
				const linkEl = link;
				const href = linkEl.getAttribute('href');
				if (href && !href.startsWith('#')) {
					// S'assurer que le lien est cliquable
					linkEl.style.pointerEvents = 'auto';
					linkEl.style.cursor = 'pointer';
					
					// Supprimer TOUS les onclick qui bloquent
					linkEl.onclick = null;
					linkEl.removeAttribute('onclick');
					
					// Logger seulement pour d√©bogage, SANS bloquer
					linkEl.addEventListener('click', function(e) {
						console.log(`üîó [blog.astro] Lien ${index} cliqu√©:`, href);
						// NE PAS appeler preventDefault ou return false
					}, false);
				}
			});
			
			// Rendre les cartes d'articles cliquables MAIS ne pas bloquer les liens
			articleCards.forEach(card => {
				const link = card.querySelector('a[href^="/blog/"]');
				if (link) {
					const href = link.getAttribute('href');
					if (href) {
						card.style.cursor = 'pointer';
						card.onclick = function(e) {
							// Si on clique sur un lien, laisser le comportement par d√©faut
							const target = e.target;
							if (target && (target.tagName === 'A' || target.closest('a'))) {
								return true; // Laisser le lien fonctionner normalement
							}
							// Sinon, naviguer depuis la carte
							console.log('üì¶ Carte article cliqu√©e (pas sur lien), navigation vers:', href);
							window.location.href = href;
							return false;
						};
					}
				}
			});
		}
		
		// Initialiser imm√©diatement et apr√®s un d√©lai
		initializeArticleLinks();
		setTimeout(initializeArticleLinks, 500);
		setTimeout(initializeArticleLinks, 1500);
	});
</script>
